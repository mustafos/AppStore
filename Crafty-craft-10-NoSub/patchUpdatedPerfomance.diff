From c013d90ce1bd322beb7632206a35503b80557b1f Mon Sep 17 00:00:00 2001
From: VitalyPolezhay <>
Date: Wed, 15 Nov 2023 17:14:37 +0200
Subject: [PATCH] updated redraw perfomance (a little bit)

---
 Crafty Craft 5.xcodeproj/project.pbxproj      |  4 +++
 .../Extensions/UIColor+Equatable.swift        | 31 ++++++++++++++++
 .../3dModel/EditorSkinModel.swift             | 36 ++++++++++++++-----
 .../SkinCreatorMain/SkinCreatorMainVC.swift   |  1 -
 4 files changed, 63 insertions(+), 9 deletions(-)
 create mode 100644 Crafty Craft 5/Extensions/UIColor+Equatable.swift

diff --git a/Crafty Craft 5.xcodeproj/project.pbxproj b/Crafty Craft 5.xcodeproj/project.pbxproj
index f10181f..9aab86b 100644
--- a/Crafty Craft 5.xcodeproj/project.pbxproj	
+++ b/Crafty Craft 5.xcodeproj/project.pbxproj	
@@ -17,6 +17,7 @@
 		033847A42A9CBA1700A55021 /* EzPopup in Frameworks */ = {isa = PBXBuildFile; productRef = 033847A32A9CBA1700A55021 /* EzPopup */; };
 		033847A62A9CBE9A00A55021 /* DocumentPicker.swift in Sources */ = {isa = PBXBuildFile; fileRef = 033847A52A9CBE9A00A55021 /* DocumentPicker.swift */; };
 		03435CC62B04C91B00423598 /* Localizable.strings in Resources */ = {isa = PBXBuildFile; fileRef = 03435CC82B04C91B00423598 /* Localizable.strings */; };
+		03435CCA2B04F6A200423598 /* UIColor+Equatable.swift in Sources */ = {isa = PBXBuildFile; fileRef = 03435CC92B04F6A200423598 /* UIColor+Equatable.swift */; };
 		035166712AFA3F0900035087 /* extensions-freeform.swift in Sources */ = {isa = PBXBuildFile; fileRef = 0351662A2AFA3F0900035087 /* extensions-freeform.swift */; };
 		035166732AFA3F0900035087 /* NetworkStatusMonitor.swift in Sources */ = {isa = PBXBuildFile; fileRef = 0351662D2AFA3F0900035087 /* NetworkStatusMonitor.swift */; };
 		037707662ADEE24B00B8D755 /* ServerDetailsViewController.swift in Sources */ = {isa = PBXBuildFile; fileRef = 037707642ADEE24B00B8D755 /* ServerDetailsViewController.swift */; };
@@ -318,6 +319,7 @@
 		0338479F2A9CB41700A55021 /* DownloadContnetViewController.xib */ = {isa = PBXFileReference; lastKnownFileType = file.xib; path = DownloadContnetViewController.xib; sourceTree = "<group>"; };
 		033847A52A9CBE9A00A55021 /* DocumentPicker.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = DocumentPicker.swift; sourceTree = "<group>"; };
 		03435CC72B04C91B00423598 /* en */ = {isa = PBXFileReference; lastKnownFileType = text.plist.strings; name = en; path = en.lproj/Localizable.strings; sourceTree = "<group>"; };
+		03435CC92B04F6A200423598 /* UIColor+Equatable.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = "UIColor+Equatable.swift"; sourceTree = "<group>"; };
 		0351662A2AFA3F0900035087 /* extensions-freeform.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = "extensions-freeform.swift"; sourceTree = "<group>"; };
 		0351662D2AFA3F0900035087 /* NetworkStatusMonitor.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = NetworkStatusMonitor.swift; sourceTree = "<group>"; };
 		037707642ADEE24B00B8D755 /* ServerDetailsViewController.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = ServerDetailsViewController.swift; sourceTree = "<group>"; };
@@ -1329,6 +1331,7 @@
 				03ACD3522ADE6A8C00052439 /* UILabel+TextInset.swift */,
 				03AC348D2AE7A69600456F51 /* UIImageView+Border.swift */,
 				038360BE2AEFA35200751797 /* String+CaseInsesetive.swift */,
+				03435CC92B04F6A200423598 /* UIColor+Equatable.swift */,
 			);
 			path = Extensions;
 			sourceTree = "<group>";
@@ -1836,6 +1839,7 @@
 				D7C842B92A6A78A6006F5020 /* MinecraftSkinManager.swift in Sources */,
 				F438AA2F2A175AE0007469E7 /* Drawing.swift in Sources */,
 				F4DB05D02A02959000E4C43D /* TabBarViewController.swift in Sources */,
+				03435CCA2B04F6A200423598 /* UIColor+Equatable.swift in Sources */,
 				1C2983C72A5EADAA00E936BA /* AddonsOptionsContainerCell.swift in Sources */,
 				63945E122A8D06970021BA28 /* AddonConstructorModel.swift in Sources */,
 				639407F42A780ABE007D6301 /* Color3DCollectionCell.swift in Sources */,
diff --git a/Crafty Craft 5/Extensions/UIColor+Equatable.swift b/Crafty Craft 5/Extensions/UIColor+Equatable.swift
new file mode 100644
index 0000000..afdd86e
--- /dev/null
+++ b/Crafty Craft 5/Extensions/UIColor+Equatable.swift	
@@ -0,0 +1,31 @@
+//
+//  UIColor+Equatable.swift
+//  Crafty Craft 5
+//
+//  Created by Vitaliy Polezhay on 15.11.2023.
+//  Copyright Â© 2023 Noname Digital. All rights reserved.
+//
+
+import Foundation
+import UIKit
+
+extension UIColor {
+  static func == (l: UIColor, r: UIColor) -> Bool {
+    var r1: CGFloat = 0
+    var g1: CGFloat = 0
+    var b1: CGFloat = 0
+    var a1: CGFloat = 0
+    l.getRed(&r1, green: &g1, blue: &b1, alpha: &a1)
+    var r2: CGFloat = 0
+    var g2: CGFloat = 0
+    var b2: CGFloat = 0
+    var a2: CGFloat = 0
+    r.getRed(&r2, green: &g2, blue: &b2, alpha: &a2)
+    return r1 == r2 && g1 == g2 && b1 == b2 && a1 == a2
+  }
+}
+func == (l: UIColor?, r: UIColor?) -> Bool {
+  let l = l ?? .clear
+  let r = r ?? .clear
+  return l == r
+}
diff --git a/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/ListOfCreatedSkinsController/Skin3DCreator/3dModel/EditorSkinModel.swift b/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/ListOfCreatedSkinsController/Skin3DCreator/3dModel/EditorSkinModel.swift
index c96dfa0..ec8fa4d 100644
--- a/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/ListOfCreatedSkinsController/Skin3DCreator/3dModel/EditorSkinModel.swift	
+++ b/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/ListOfCreatedSkinsController/Skin3DCreator/3dModel/EditorSkinModel.swift	
@@ -2,6 +2,7 @@
 
 import Foundation
 import UIKit
+import SceneKit
 
 enum BrashSize: Int, CaseIterable {
     case one = 1
@@ -91,7 +92,9 @@ class EditorSkinModel {
                     if sideNode.name == rNodeName {
                         sideNode.childNodes.forEach { pixelNode in
                             if Int(pixelNode.name ?? "0") == command.indexes[i] {
-                                pixelNode.geometry?.firstMaterial?.diffuse.contents = command.colors[i]
+                                if let color = pixelNode.geometry?.firstMaterial?.diffuse.contents as? UIColor, color == command.colors[i] {} else {
+                                    pixelNode.geometry?.firstMaterial?.diffuse.contents = command.colors[i]
+                                }
                             }
                         }
                     }
@@ -165,7 +168,9 @@ class EditorSkinModel {
                 if sideNode.name == nameRootNod {
                     sideNode.childNodes.forEach { pixelNode in
                         if pixelNode.name != nameRootNod {
-                            pixelNode.geometry?.firstMaterial?.diffuse.contents = currentDrawingColor
+                            if let color = pixelNode.geometry?.firstMaterial?.diffuse.contents as? UIColor, color == currentDrawingColor {} else {
+                                pixelNode.geometry?.firstMaterial?.diffuse.contents = currentDrawingColor
+                            }
                         }
                     }
                 }
@@ -197,10 +202,9 @@ class EditorSkinModel {
     
     private func changePixelArray(indexArray: [Int], color: UIColor, nameRootNod: String, gestureState: UIGestureRecognizer.State) {
         if let node = controller.sceneView.scene!.rootNode.childNodes.first(where: { $0.name == nameRootNod }) {
-            if let _ = node.childNodes.first(where: { $0.name != node.name && Int($0.name ?? "0") == (indexArray.first ?? 0) }) {
-                
-                let oldColors = getColorsFromSkinNodes(by: indexArray, nameRootNod: nameRootNod)
-                
+            if node.childNodes.contains(where: { $0.name != node.name && Int($0.name ?? "0") == (indexArray.first ?? 0) }) {
+                let oldColors = getColorsFromSkinNodes(by: indexArray, node: node)
+
                 if gestureState == .ended {
                     if drawSkinCommands.undoCommands.count > commandIndex {
                         drawSkinCommands.undoCommands.removeLast(drawSkinCommands.undoCommands.count - commandIndex)
@@ -250,10 +254,16 @@ class EditorSkinModel {
                         break
                     }
                     colorlForSideNodes[nameRootNod]?[i] = newColor
-                    node.childNodes[i].geometry?.firstMaterial?.diffuse.contents = newColor
+                    if let color = node.childNodes[i].geometry?.firstMaterial?.diffuse.contents as? UIColor, color == newColor {
+                        
+                    } else {
+                        print("NOT REUSE")
+                        node.childNodes[i].geometry?.firstMaterial?.diffuse.contents = newColor
+                    }
+                    
                 }
                 
-                let newColors = getColorsFromSkinNodes(by: indexArray, nameRootNod: nameRootNod)
+                let newColors = getColorsFromSkinNodes(by: indexArray, node: node)
                 
                 if gestureState == .ended {
                     drawSkinCommands.redoCommands.append(SkinCommand(indexes: indexArray, colors: newColors, nodeName: Array(repeating: nameRootNod, count: indexArray.count)))
@@ -393,6 +403,16 @@ class EditorSkinModel {
         return color
     }
     
+    private func getColorsFromSkinNodes(by indexArray: [Int], node: SCNNode) -> [UIColor] {
+        var nodeColors = [UIColor]()
+        for i in indexArray {
+            if let nodeColor = node.childNodes[i].geometry?.firstMaterial?.diffuse.contents as? UIColor {
+                nodeColors.append(nodeColor)
+            }
+        }
+        return nodeColors
+    }
+    
     private func getColorsFromSkinNodes(by indexArray: [Int], nameRootNod: String) -> [UIColor] {
         var nodeColors = [UIColor]()
         for i in indexArray {
diff --git a/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/SkinCreatorMain/SkinCreatorMainVC.swift b/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/SkinCreatorMain/SkinCreatorMainVC.swift
index b62cfe6..b1648ba 100644
--- a/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/SkinCreatorMain/SkinCreatorMainVC.swift	
+++ b/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/SkinCreatorMain/SkinCreatorMainVC.swift	
@@ -58,7 +58,6 @@ class SkinCreatorMainVC: UIViewController {
     
     override func viewDidLayoutSubviews() {
         super.viewDidLayoutSubviews()
-        print("AAAAA")
         menuCollectionView.reloadData()
     }
     
-- 
2.37.0


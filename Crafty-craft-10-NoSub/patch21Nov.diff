From 9f963d1ed7aa2c29091ac74666ef1b34319eb284 Mon Sep 17 00:00:00 2001
From: VitalyPolezhay <>
Date: Tue, 21 Nov 2023 15:33:50 +0200
Subject: [PATCH] fixed bugs 21 nov

---
 .../Manager/PhotoGalleryManager.swift         | 18 +++++++--------
 .../ContentViewController+SaveImage.swift     |  2 +-
 .../ContentTabViewController.swift            |  4 +++-
 .../AddonCreatorMainVC.swift                  | 22 +++++++++++++++++++
 .../AddonEditor3DModel.swift                  |  2 +-
 ...tension_EditorSkinModel+SaveAndShare.swift |  2 +-
 .../Seed Tab/SeedTabViewController.swift      |  2 +-
 .../Server Tab/ServersTabViewController.swift |  7 ++++--
 8 files changed, 43 insertions(+), 16 deletions(-)

diff --git a/Crafty Craft 5/Manager/PhotoGalleryManager.swift b/Crafty Craft 5/Manager/PhotoGalleryManager.swift
index e512fe8..219e181 100644
--- a/Crafty Craft 5/Manager/PhotoGalleryManager.swift	
+++ b/Crafty Craft 5/Manager/PhotoGalleryManager.swift	
@@ -27,22 +27,22 @@ class PhotoGalleryManager: NSObject, PhotoGalleryManagerProtocol {
         
         self.getImageCompletion = completion
         
-//        requestAuthorizationAndSaveImageToLibrary(from: viewController) { [weak self] granted, vc in
+        requestAuthorizationAndSaveImageToLibrary(from: viewController) { [weak self] granted, vc in
             DispatchQueue.main.async {
                 
-//                guard let me = self else {
-//                    assert(false, "wrong construction")
-//                    return
-//                }
+                guard let me = self else {
+                    assert(false, "wrong construction")
+                    return
+                }
                 
                 let imagePicker = UIImagePickerController()
-                imagePicker.delegate = self
+                imagePicker.delegate = me
                 imagePicker.sourceType = .photoLibrary
                 imagePicker.allowsEditing = false
                 
-                viewController.present(imagePicker, animated: true)
+                vc?.present(imagePicker, animated: true)
             }
-//        }
+        }
     }
     
     func getImageFromCamera(from viewController: UIViewController, completion: @escaping GetImageCompletion) {
@@ -94,7 +94,7 @@ class PhotoGalleryManager: NSObject, PhotoGalleryManagerProtocol {
     }
     
     private func requestAuthorizationAndSaveImageToLibrary(from viewController: UIViewController, completion: @escaping (Bool, UIViewController?) -> ()) {
-        PHPhotoLibrary.requestAuthorization(for: .addOnly) { [weak self, viewController] (status) in
+        PHPhotoLibrary.requestAuthorization { [weak self, viewController] (status) in
             switch status {
             case .authorized:
                 completion(true, viewController)
diff --git a/Crafty Craft 5/Tab Bar/Content Tab/Content Module/ContentViewController+SaveImage.swift b/Crafty Craft 5/Tab Bar/Content Tab/Content Module/ContentViewController+SaveImage.swift
index 8f137b3..3b0d8a7 100644
--- a/Crafty Craft 5/Tab Bar/Content Tab/Content Module/ContentViewController+SaveImage.swift	
+++ b/Crafty Craft 5/Tab Bar/Content Tab/Content Module/ContentViewController+SaveImage.swift	
@@ -12,7 +12,7 @@ import UIKit
 
 extension ContentViewController {
     func requestAuthorizationAndSaveImageToLibrary(image: UIImage) {
-        PHPhotoLibrary.requestAuthorization(for: .addOnly) { [weak self] (status) in
+        PHPhotoLibrary.requestAuthorization { [weak self] (status) in
             switch status {
             case .authorized:
                 self?.saveImageToPhotoLibrary(image: image)
diff --git a/Crafty Craft 5/Tab Bar/Content Tab/ContentTabViewController.swift b/Crafty Craft 5/Tab Bar/Content Tab/ContentTabViewController.swift
index 66bbba3..20eea50 100755
--- a/Crafty Craft 5/Tab Bar/Content Tab/ContentTabViewController.swift	
+++ b/Crafty Craft 5/Tab Bar/Content Tab/ContentTabViewController.swift	
@@ -686,7 +686,9 @@ extension ContentTabViewController: UITableViewDelegate, UITableViewDataSource {
 
     func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
         let cell = tableView.dequeueReusableCell(withIdentifier: SearchSuggestionCell.identifier) as! SearchSuggestionCell
-        cell.titleLabel.text = filteredPageModel[indexPath.row].name
+        if filteredPageModel.count > indexPath.row {
+            cell.titleLabel.text = filteredPageModel[indexPath.row].name
+        }
         cell.selectionStyle = .none
         return cell
     }
diff --git a/Crafty Craft 5/Tab Bar/Create Tab/Addon Creator/AddonCreatorCollection/AddonCreatorMainVC.swift b/Crafty Craft 5/Tab Bar/Create Tab/Addon Creator/AddonCreatorCollection/AddonCreatorMainVC.swift
index 1677485..58964ee 100644
--- a/Crafty Craft 5/Tab Bar/Create Tab/Addon Creator/AddonCreatorCollection/AddonCreatorMainVC.swift	
+++ b/Crafty Craft 5/Tab Bar/Create Tab/Addon Creator/AddonCreatorCollection/AddonCreatorMainVC.swift	
@@ -291,6 +291,28 @@ extension AddonCreatorMainVC {
         
         let url = FileManager.default.documentDirectory.appendingPathComponent(savedAddon.file)
         
+        //HARD FIX
+        if savedAddon.file == "mcaddons" {
+                    
+            if let imageData = savedAddon.displayImageData, let image = UIImage(data: imageData) {
+                share(image: image, from: downloadButton)
+            } else if let image = ImageCacheManager.shared.image(forKey: savedAddon.idshka) {
+                share(image: image, from: downloadButton)
+            } else {
+                DropBoxParserFiles.shared.getBloodyImageURLFromDropBox(img: savedAddon.displayImage) { [weak self] theUrl in
+                    guard theUrl != nil else { return }
+                    CustomImageLoader().loadImage(from: theUrl!, id: savedAddon.idshka) { [weak self] img in
+                        guard let img, let self else { return }
+                        self.share(image: img, from: self.downloadButton)
+                    }
+                }
+            }
+            return
+        }
+        
+
+        
+        
         // Check if the file exists at the specified URL.
         if FileManager.default.fileExists(atPath: url.path) {
             share(url: url, from: downloadButton)
diff --git a/Crafty Craft 5/Tab Bar/Create Tab/Addon Creator/AddonEditor3DModule/AddonEditor3DModel.swift b/Crafty Craft 5/Tab Bar/Create Tab/Addon Creator/AddonEditor3DModule/AddonEditor3DModel.swift
index e13f416..0b1bacb 100644
--- a/Crafty Craft 5/Tab Bar/Create Tab/Addon Creator/AddonEditor3DModule/AddonEditor3DModel.swift	
+++ b/Crafty Craft 5/Tab Bar/Create Tab/Addon Creator/AddonEditor3DModule/AddonEditor3DModel.swift	
@@ -298,7 +298,7 @@ extension AddonEditor3DVCModel {
     }
     
     func requestAuthorizationAndSaveImageToLibrary(image: UIImage) {
-        PHPhotoLibrary.requestAuthorization(for: .addOnly) { [weak self] (status) in
+        PHPhotoLibrary.requestAuthorization { [weak self] (status) in
             switch status {
             case .authorized:
                 self?.saveImageToPhotoLibrary(image: image)
diff --git a/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/ListOfCreatedSkinsController/Skin3DCreator/3dModel/Extension_EditorSkinModel+SaveAndShare.swift b/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/ListOfCreatedSkinsController/Skin3DCreator/3dModel/Extension_EditorSkinModel+SaveAndShare.swift
index 4330b65..9b07e15 100644
--- a/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/ListOfCreatedSkinsController/Skin3DCreator/3dModel/Extension_EditorSkinModel+SaveAndShare.swift	
+++ b/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/ListOfCreatedSkinsController/Skin3DCreator/3dModel/Extension_EditorSkinModel+SaveAndShare.swift	
@@ -36,7 +36,7 @@ extension EditorSkinModel {
     }
     
     func requestAuthorizationAndSaveImageToLibrary(image: UIImage) {
-        PHPhotoLibrary.requestAuthorization(for: .addOnly){ [weak self] (status) in
+        PHPhotoLibrary.requestAuthorization { [weak self] (status) in
             switch status {
             case .authorized:
                 self?.saveImageToPhotoLibrary(image: image)
diff --git a/Crafty Craft 5/Tab Bar/Seed Tab/SeedTabViewController.swift b/Crafty Craft 5/Tab Bar/Seed Tab/SeedTabViewController.swift
index 5ba6e9b..0f131f3 100644
--- a/Crafty Craft 5/Tab Bar/Seed Tab/SeedTabViewController.swift	
+++ b/Crafty Craft 5/Tab Bar/Seed Tab/SeedTabViewController.swift	
@@ -124,7 +124,7 @@ class SeedTabViewController: UIViewController {
         if filteredText == nil {
             dataSourceSeed = seeds
         } else {
-            dataSourceSeed = seeds.filter({$0.name.contains(filteredText ?? "")})
+            dataSourceSeed = seeds.filter({$0.name.containsCaseInsesetive(filteredText ?? "")})
         }
     }
     
diff --git a/Crafty Craft 5/Tab Bar/Server Tab/ServersTabViewController.swift b/Crafty Craft 5/Tab Bar/Server Tab/ServersTabViewController.swift
index b920c0a..9f377a4 100644
--- a/Crafty Craft 5/Tab Bar/Server Tab/ServersTabViewController.swift	
+++ b/Crafty Craft 5/Tab Bar/Server Tab/ServersTabViewController.swift	
@@ -172,7 +172,7 @@ class ServersTabViewController: UIViewController {
         if filteredText == nil {
             dataSourceServers = servers
         } else {
-            dataSourceServers = servers.filter({$0.name.contains(filteredText ?? "")})
+            dataSourceServers = servers.filter({$0.name.containsCaseInsesetive(filteredText ?? "")})
         }
     }
     
@@ -275,7 +275,10 @@ extension ServersTabViewController: UITableViewDataSource, UITableViewDelegate {
     func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
         if tableView == suggestionsTableView{
             let cell = tableView.dequeueReusableCell(withIdentifier: SearchSuggestionCell.identifier) as! SearchSuggestionCell
-            cell.titleLabel.text = dataSourceServers[indexPath.row].name
+            if dataSourceServers.count > indexPath.row {
+                cell.titleLabel.text = dataSourceServers[indexPath.row].name
+            }
+            
             cell.selectionStyle = .none
             return cell
         }
-- 
2.37.0


From b945658e92a3104a4464275edeae1e905183f4ff Mon Sep 17 00:00:00 2001
From: VitalyPolezhay <>
Date: Tue, 26 Sep 2023 12:11:51 +0300
Subject: [PATCH] fixed bug with 2d skin editor, updated cache loader, hide
 stive on save mode

---
 .../Extensions/UIImage+Resized.swift          | 37 +++++++++++++++++++
 Crafty Craft 5/Realm/Cacher.swift             |  2 +-
 .../ListTableViewCell/ListTableViewCell.swift |  8 +++-
 .../SkinCreatorViewController.swift           |  3 ++
 .../Skin3DTestViewController.swift            |  1 +
 5 files changed, 48 insertions(+), 3 deletions(-)

diff --git a/Crafty Craft 5/Extensions/UIImage+Resized.swift b/Crafty Craft 5/Extensions/UIImage+Resized.swift
index bda4fb3..06de03f 100755
--- a/Crafty Craft 5/Extensions/UIImage+Resized.swift	
+++ b/Crafty Craft 5/Extensions/UIImage+Resized.swift	
@@ -22,11 +22,47 @@ extension UIImage {
         UIGraphicsEndImageContext()
         return resizedImage
     }
+    
+    func resizeImageTo(size: CGSize) -> UIImage? {
+        UIGraphicsBeginImageContextWithOptions(size, false, 0.0)
+        self.draw(in: CGRect(origin: CGPoint.zero, size: size))
+        let resizedImage = UIGraphicsGetImageFromCurrentImageContext()!
+        UIGraphicsEndImageContext()
+        return resizedImage
+    }
 }
 
 
 /// Taken from https://stackoverflow.com/a/34599236/7217195
 extension UIImage {
+    func scalePreservingAspectRatio(targetSize: CGSize) -> UIImage {
+            // Determine the scale factor that preserves aspect ratio
+            let widthRatio = (targetSize.width + 1) / size.width
+            let heightRatio = (targetSize.height + 1) / size.height
+            
+            let scaleFactor = min(widthRatio, heightRatio)
+            
+            // Compute the new image size that preserves aspect ratio
+            let scaledImageSize = CGSize(
+                width: size.width * scaleFactor,
+                height: size.height * scaleFactor
+            )
+
+            // Draw and return the resized UIImage
+            let renderer = UIGraphicsImageRenderer(
+                size: scaledImageSize
+            )
+
+            let scaledImage = renderer.image { _ in
+                self.draw(in: CGRect(
+                    origin: .zero,
+                    size: scaledImageSize
+                ))
+            }
+            
+            return scaledImage
+        }
+    
     func scaleImage(toSize newSize: CGSize) -> UIImage? {
         var newImage: UIImage?
         let newRect = CGRect(x: 0, y: 0, width: newSize.width, height: newSize.height).integral
@@ -84,6 +120,7 @@ extension UIImage {
         
         let rectWidth = width ?? imgTotalWidth
         let rectHeight = height ?? imgTotalHeight
+        
         let localStartX = startX ?? 0
         let localStartY = startY ?? 0
         
diff --git a/Crafty Craft 5/Realm/Cacher.swift b/Crafty Craft 5/Realm/Cacher.swift
index 18c018e..e6fd36d 100644
--- a/Crafty Craft 5/Realm/Cacher.swift	
+++ b/Crafty Craft 5/Realm/Cacher.swift	
@@ -20,7 +20,7 @@ open class CustomImageLoader: UIImageView {
         
         if let imageFromCache = cache.image(forKey: id) {
             self.image = imageFromCache
-            
+            completion(imageFromCache)
             return
         }
         
diff --git a/Crafty Craft 5/Tab Bar/Create Tab/Addon Creator/AddonOptionsViewController/ListTableViewCell/ListTableViewCell.swift b/Crafty Craft 5/Tab Bar/Create Tab/Addon Creator/AddonOptionsViewController/ListTableViewCell/ListTableViewCell.swift
index e1de41a..4b4c6d0 100755
--- a/Crafty Craft 5/Tab Bar/Create Tab/Addon Creator/AddonOptionsViewController/ListTableViewCell/ListTableViewCell.swift	
+++ b/Crafty Craft 5/Tab Bar/Create Tab/Addon Creator/AddonOptionsViewController/ListTableViewCell/ListTableViewCell.swift	
@@ -28,7 +28,9 @@ class ListTableViewCell: UITableViewCell {
             DropBoxParserFiles.shared.getBloodyImageURLFromDropBox(img: addonModel.displayImage) { [weak self] imgPAth in
                 if let imgPath = imgPAth {
                     self?.cellImage.loadImage(from: imgPath, id: addonModel.idshka) { img in
-                        addonModel.displayImageData = img?.pngData()
+                        if addonModel.displayImageData == nil {
+                            addonModel.displayImageData = img?.pngData()
+                        }
                     }
                 }
             }
@@ -43,7 +45,9 @@ class ListTableViewCell: UITableViewCell {
             DropBoxParserFiles.shared.getBloodyImageURLFromDropBox(img: category.imagePathName) { [weak self] imgPAth in
                 if let imgPath = imgPAth {
                     self?.cellImage.loadImage(from: imgPath, id: category.imagePathName) { img in
-                        category.displayImageData = img?.pngData()
+                        if category.displayImageData == nil {
+                            category.displayImageData = img?.pngData()
+                        }
                     }
                 }
             }
diff --git a/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/ListOfCreatedSkinsController/Skin2DCreator/BodyPart2DPickerVC/SkinCreatorController/SkinCreatorViewController.swift b/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/ListOfCreatedSkinsController/Skin2DCreator/BodyPart2DPickerVC/SkinCreatorController/SkinCreatorViewController.swift
index 992dfe0..e34957e 100755
--- a/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/ListOfCreatedSkinsController/Skin2DCreator/BodyPart2DPickerVC/SkinCreatorController/SkinCreatorViewController.swift	
+++ b/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/ListOfCreatedSkinsController/Skin2DCreator/BodyPart2DPickerVC/SkinCreatorController/SkinCreatorViewController.swift	
@@ -360,6 +360,9 @@ class SkinCreatorViewController: UIViewController, PKCanvasViewDelegate, PKToolP
         var colorsArr: [UIColor]?
         
         colorsArr = currentEditableSkin?.skinAssemblyDiagram?
+            
+            .resizeImageTo(size: .init(width: currentBodyPartSide?.width ?? 64,
+                                       height: currentBodyPartSide?.height ?? 64))?
             .rotate(radians: CGFloat.pi/2)?
             .extractPixelColors(width: currentBodyPartSide?.width,
                                 height: currentBodyPartSide?.height,
diff --git a/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/ListOfCreatedSkinsController/Skin3DCreator/Skin3DTestViewController.swift b/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/ListOfCreatedSkinsController/Skin3DCreator/Skin3DTestViewController.swift
index 01cfd00..1020a48 100755
--- a/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/ListOfCreatedSkinsController/Skin3DCreator/Skin3DTestViewController.swift	
+++ b/Crafty Craft 5/Tab Bar/Create Tab/SkinsCreator/ListOfCreatedSkinsController/Skin3DCreator/Skin3DTestViewController.swift	
@@ -567,6 +567,7 @@ extension Skin3DTestViewController: SkinSavebleDialogDelegate {
     func saveSkin(with name: String, withExit: Bool) {
         editorSkinModel.saveSkinsAssemblyDiagram(with: name)
         hideSaveAlertView()
+        smallStiveView.isHidden = true
         if withExit {
             navigationController?.popViewController(animated: true)
         } else {
-- 
2.37.0

